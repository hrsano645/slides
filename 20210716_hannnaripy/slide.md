---
marp: true
header: "**ほぼPython標準ライブラリでオープンデータを触った話** 2021/07/16 はんなりPython LT"
# footer: "by [@hrs_sano645](https://twitter.com/hrs_sano645)"
paginate: true
backgroundColor: #eee
---

# ほぼPython標準ライブラリでオープンデータを触った話

2021/07/16 はんなりPython LT


---

## お前誰よ

- 佐野浩士（Hiroshi Sano）[@hrs_sano645](https://twitter.com/hrs_sano645) 🏠:静岡県の富士市🗻
- Job💼
  - [佐野設計事務所🚗⚙️📏🖊️](https://sano-design.info)
    - 自動車系機械の3D設計事務所 ソフトウェアエンジニア 他いろいろ
  - 米農家🌾
- Community🧑‍💻
  - 🐍: Python駿河, PyCon mini Shizuokaスタッフ
  - 🏙💻: Code for ふじのくに

<!-- _footer:  -->

---

ほぼPython標準ライブラリでオープンデータを触った話

<!-- _footer:  -->

---

ってどういうこと？

<!-- _footer:  -->

---

## このLTの趣旨

- 気軽にオープンデータを扱ってみよう
- Pythonの標準ライブラリでも何とかいける
- オチはない

---

# このLTのことの始まり

---


## 新型コロナ対策サイトの地元版やってます

- 静岡県（住んでる市
- 富士市（住んでる市

<!-- _footer: 有志チームでやってます。静岡市と浜松市にもあります -->

---

画像

---

## 「新型コロナ対策サイト」とは

「新型コロナ対策サイト」はシビックテックという取り組みで製作されたプロダクト

- 東京都/Code for Japan が東京都版を作成
  - メトロ版
  - 利用するデータのフォーマットやサイトの作成方法がほとんど公開されてる
  - issueやPRの受付も大歓迎 -> 2020年に一気に注目を浴びる
- OSSで作られている -> フォーク可能
  - 静岡県
- そのほか地域に広まる
  - FORKED SITE

---

サイトの構成

---

サイトの作成方法



---

どこにPythonつかってるの?

ここ！


---

### 新型コロナ対策サイトを動かすためにデータを作る

- オープンデータはCSVで提供される
- CSV形式の情報を元に、専用のjsonファイルを作る
- データの前処理はある程度必要
  - オープンデータあるある

---

### 諸事情でPythonオンリーで始める

- 当時はデプロイ周りをサーバー側で行うことにした
- Pythonの環境は3.7あたりが入ってることは把握
  - さくらインターネットで動かすことにして
- 立ち上げ早めに動きたかったので、データ処理を突貫で進める
 -> ちょっとずつ改善していくことにした

Python標準で大丈夫っしょというところ

---

### 変換するためのスクリプトを作った

こちら -> 

- データのダウンロードはサーバー側にあるcurlでやりました
- csv, json あたりを使う
- 前処理は正規表現とか、データの事情を元に独自実装する

---

本当にPythonの標準ライブラリだけ？

---

本当です！

```Python
# coding:utf-8
import re
import csv
import json
import sys
from collections import Counter, namedtuple
from datetime import datetime, timedelta
```

-> https://github.com/hrsano645/covid19-gen-datajson-shizuokapref/blob/master/patients.py#L1

---

# 中身解説

---

まずはこの辺

---

## データのダウンロード

- ここはPythonではなくても正直何でもよかった -> curlとかで十分
- ダウンロードできれば何でも良いのよ

---

## データのダウンロード:Pythonでやるなら

Pythonでやるなら http.clientで良さそう


---

## CSVファイルを開く

import csvで開く

ヘッダがあるようなものは csv.DictReaderでやろう。辞書形式で見れる

---



---

## データの前処理をする

今回オープンデータで困ったこと

- 冒頭にデータの説明が乗っている
  - ~~Excelな文化...~~
- 通常だと作られないような行列構造になってる
- 各データの表記がブレてる

---

こんなのやあんなの（画像載せる）

---

### データの前処理をする: 不必要なデータを除外する



---

### データの前処理をする: 例外的な行や列を消す

---

### データの前処理: 表記ブレな文字列の置き換え

- reモジュールとかはよく使えるといいと思う
  - str.replaceでも良いです
- **いちいち毎回呼び出すのは面倒** なので関数化, 置き換えルールをnamedTupleでまとめてます

---

---


### jsonファイルを作る

- jsonモジュールを使おう
- jsonの構造はそのまま **"文字列"** として扱って、json.loadsするととても便利に扱える

---

ということでうまくいきました👍

---

## Python標準ライブラリでも面倒なこと

- オープンデータがExcel, PDF系
  - Excelだったらpandas（というか普通にcsvもpandasでいいと思う）
  - PDFにある表だとtabula-py（を最近知った）
- データがページ上に展開
  - スクレイピング: requests+beautifulsoup4, selenium, ...
- APIが公開されてる
  - requestsや必要なら認証サポートするもの

---

## とりあえずまとめ

- Pythonでオープンデータを扱うことはできる！
- 標準ライブラリはまだまだ便利なものがある！
どこかで探索したいですね

---

## 続きは別の機会に… 

<!-- _footer: CfS通ったらいいなーと -->
